bitcoin-core:
  service:
    ports:
      rpc: 43782
      p2p: 39388
    extraPorts:
      - name: zmqpubrawblock 
        port: 28332
        targetPort:  28332
      - name: zmqpubrawtx
        port: 28333
        targetPort: 28333

  persistence:
    accessMode: ReadWriteOnce
    size: 1Gi

  config: |
    server=1
    txindex=1
    chain=regtest
    rpcserialversion=0
    rpcuser=ceiwHEbqWI83
    rpcpassword=XB62kURh0JUTOhIpC-WV7X6m4jGuVvwsyQV4m_EP9C4=
    whitelist=127.0.0.1
    whitebind=0.0.0.0:39388

    [regtest]
    debug=rpc
    rpcallowip=0.0.0.0/0
    rpcbind=0.0.0.0
    dbcache=75
    maxorphantx=10
    maxmempool=150
    nodebuglogfile=1
    zmqpubrawblock=tcp://0.0.0.0:28332
    zmqpubrawtx=tcp://0.0.0.0:28333
    deprecatedrpc=signrawtransaction
    fallbackfee=0.0002
    rpcport=43782
    rpclisten=0.0.0.0:10009
    restlisten=0.0.0.0:8080


lnd:
  loop:
    enable: false
  pool:
    enable: false
  configurationFile:
    lnd.conf: |-
      restlisten=0.0.0.0:8080
      rpclisten=127.0.0.1:10009
      bitcoin.node=bitcoind
      bitcoin.active=1
      bitcoin.regtest=1
      bitcoind.rpchost=btcpayserver-bitcoin-core-0:43782
      bitcoind.rpcuser=ceiwHEbqWI83
      bitcoind.rpcpass=XB62kURh0JUTOhIpC-WV7X6m4jGuVvwsyQV4m_EP9C4=
      bitcoind.zmqpubrawblock=tcp://btcpayserver-bitcoin-core-0:28332
      bitcoind.zmqpubrawtx=tcp://btcpayserver-bitcoin-core-0:28333
      bitcoin.defaultchanconfs=1
      debuglevel=debug
      trickledelay=1000
  internalServices:
    rpcPort: 10009
    restPort: 8080
  # Ports that are visible outside your cluster
  externalServices:
    p2pPort: 9735
  persistence:
    size: 1Gi

nbxplorer:
  service:
    type: ClusterIP
    port: 32838
  persistence:
    size: 1Gi
  settingsConfig: |
    bind=0.0.0.0:32838
    network=regtest
    chains=btc
    btcrpcurl=http://btcpayserver-bitcoin-core-0:43782
    btcnodeendpoint=btcpayserver-bitcoin-core-0:39388
    btcrpcauth=ceiwHEbqWI83:XB62kURh0JUTOhIpC-WV7X6m4jGuVvwsyQV4m_EP9C4=
    rmquser="rabbituser"
    rmqpass=""
    rmqhost=nbxplorer-rabbitmq
    rmqvirtual=/
    rmqtranex=NewTransaction
    rmqblockex=NetBlock
    noauth=true

postgresql:
  auth:
    username: btcpayadmin
    password: p@ssw0rd!
  primary:
    initdb: 
      user: btcpayadmin
      password: p@ssw0rd!
      database: testDB
      scripts:
        my_init_script.sh: |
          #!/bin/sh
          echo "executing script"
        my_script.sql: |
          CREATE DATABASE nbxplorer; 
          CREATE DATABASE btcpayserver;
    persistence:
      size: 1Gi
  readReplicas:
    persistence:
      size: 1Gi
  image:
    debug: true

### btcpayserver section

env:  
  BTCPAY_NETWORK: 'regtest'
  BTCPAY_POSTGRES: "User ID=btcpayadmin;Password=p@ssw0rd!;Include Error Detail=true;Host=btcpayserver-postgresql;Port=5432;Database=btcpayserver"
  BTCPAY_EXPLORERPOSTGRES: "User ID=btcpayadmin;Password=p@ssw0rd!;Include Error Detail=true;Host=btcpayserver-postgresql;Port=5432;Database=nbxplorer"
  BTCPAY_BTCEXPLORERURL: "http://btcpayserver-nbxplorer:32838"
  BTCPAY_BTCEXTERNALLNDREST: "type=lnd-rest;server=http://btcpayserver-lnd-internal:8080/;allowinsecure=true"
  BTCPAY_VERBOSE: "true"
  BTCPAY_DEBUGLOG: "debug.log"
  ASPNETCORE_URLS: "http://*:23002"
  BTCPAY_ALLOW-ADMIN-REGISTRATION: "true"
  
initScript: | 
  #!/bin/bash
  apt update -y
  apt upgrade -y
  apt install curl -y
  apt install jq -y  
  export address='addr(bcrt1ppjj995khlhftanw7ak4zyzu3650rlmpfr9p4tafegw3u38h7vx4qnxemeg)'
  export descriptor='addr(bcrt1ppjj995khlhftanw7ak4zyzu3650rlmpfr9p4tafegw3u38h7vx4qnxemeg)#hzc3j2sf'
  export user=ceiwHEbqWI83 
  export password=XB62kURh0JUTOhIpC-WV7X6m4jGuVvwsyQV4m_EP9C4=
  export url=btcpayserver-bitcoin-core-0:43782

  curl --user $user:$password \
     --data-binary "{\"jsonrpc\": \"1.0\", \"id\": \"curltest\", \"method\": \"getdescriptorinfo\", \"params\": [\"$address\"]}" \
     -H 'content-type: text/plain;' \
     $url | jq

  curl --user $user:$password --data-binary "{\"jsonrpc\": \"1.0\", \"id\": \"curltest\", \"method\": \"createwallet\", \"params\": [\"my_wallet\", true, false,\"\",false,true,true]}" -H 'content-type: text/plain;' $url | jq
  curl --user $user:$password --data-binary "{\"jsonrpc\": \"1.0\", \"id\": \"curltest\", \"method\": \"importdescriptors\", \"params\": [[{\"desc\":\"$descriptor\",\"timestamp\":\"now\"}]]}" -H 'content-type: text/plain;' $url | jq
  curl --user $user:$password --data-binary '{\"jsonrpc\": \"1.0\", \"id\": \"curltest\", \"method\": \"generatetodescriptor\", \"params\": '[50, $descriptor]'}'  -H 'content-type: text/plain;' $url  | jq

  curl --user $user:$password \
     --data-binary "{\"jsonrpc\": \"1.0\", \"id\": \"curltest\", \"method\": \"generatetodescriptor\", \"params\": [150, \"$descriptor\"]}" \
     -H 'content-type: text/plain;' \
     $url | jq


  